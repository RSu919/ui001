<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶æ•¸æ“šç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            ğŸ“Š å¯¦é©—æ•¸æ“šä¸‹è¼‰ä¸­å¿ƒ
        </h1>

        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8">
            <p class="text-blue-700 text-sm">
                <strong>ç‹€æ…‹æª¢æŸ¥ï¼š</strong> ç³»çµ±æœƒç›´æ¥é€£ç·šè‡³ Supabase `experiment_results` è³‡æ–™è¡¨ã€‚
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="border rounded-lg p-6 hover:bg-gray-50 transition">
                <h3 class="font-bold mb-2">æ­¥é©Ÿ 1ï¼šæª¢æŸ¥æ¬Šé™</h3>
                <p class="text-gray-600 text-sm mb-4">è«‹ç¢ºä¿å·²åœ¨ Supabase åŸ·è¡Œé <code>Enable select for anon</code> æ”¿ç­–ã€‚</p>
            </div>

            <div class="border rounded-lg p-6 hover:bg-gray-50 transition">
                <h3 class="font-bold mb-2">æ­¥é©Ÿ 2ï¼šåŸ·è¡Œä¸‹è¼‰</h3>
                <button onclick="downloadData()" id="btn-download" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center">
                    <span id="btn-text">ğŸ“¥ åŒ¯å‡ºå®Œæ•´å¯¦é©—æ•¸æ“š (.csv)</span>
                </button>
            </div>
        </div>

        <div id="status-msg" class="mt-6 text-center text-sm font-medium hidden"></div>
    </div>

    <script>
        const supabaseUrl = 'https://gceaxslljccatxvvohtx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjZWF4c2xsamNjYXR4dnZvaHR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTI1ODAsImV4cCI6MjA4NjM2ODU4MH0.QJvdg8gYt_zX8HN7rfylt2UrgNhJ8HeldygRkaVhEX8';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function downloadData() {
            const btn = document.getElementById('btn-download');
            const btnText = document.getElementById('btn-text');
            const msg = document.getElementById('status-msg');

            btn.disabled = true;
            btnText.innerText = "æ­£åœ¨é€£ç·šè³‡æ–™åº«...";
            msg.classList.remove('hidden', 'text-red-500', 'text-green-500');
            msg.classList.add('text-gray-500');
            msg.innerText = "æ­£åœ¨æŠ“å–è³‡æ–™ï¼Œè«‹ç¨å€™...";

            try {
                // 1. æŠ“å–æ‰€æœ‰æ•¸æ“š
                const { data, error } = await _supabase
                    .from('experiment_results')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    alert("ç›®å‰è³‡æ–™åº«ä¸­å°šç„¡æ•¸æ“šï¼è«‹ç¢ºèªå—è©¦è€…å·²å®Œæˆå¯¦é©—ï¼Œæˆ–æª¢æŸ¥ Supabase çš„ RLS Select æ”¿ç­–ã€‚");
                    return;
                }

                // 2. å°‡ JSON è½‰æ›ç‚º CSV
                const csvRows = [];
                // å–å¾—æ‰€æœ‰æ¬„ä½åç¨±ä½œç‚ºæ¨™é¡Œ
                const headers = Object.keys(data[0]);
                csvRows.push(headers.join(','));

                for (const row of data) {
                    const values = headers.map(header => {
                        let val = row[header];
                        // è™•ç† JSON ç‰©ä»¶ (å¦‚ survey_data) è½‰æˆå­—ä¸²
                        if (typeof val === 'object' && val !== null) {
                            val = JSON.stringify(val).replace(/"/g, '""');
                            return `"${val}"`;
                        }
                        // è™•ç†å«é€—è™Ÿçš„å…§å®¹
                        if (typeof val === 'string' && val.includes(',')) {
                            return `"${val.replace(/"/g, '""')}"`;
                        }
                        return val;
                    });
                    csvRows.push(values.join(','));
                }
                const csvContent = "\uFEFF" + csvRows.join('\n'); // åŠ å…¥ BOM è§£æ±º Excel äº‚ç¢¼

                // 3. è§¸ç™¼ç€è¦½å™¨ä¸‹è¼‰
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `experiment_data_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                msg.innerText = `æˆåŠŸåŒ¯å‡º ${data.length} ç­†æ•¸æ“šï¼`;
                msg.classList.add('text-green-600');
            } catch (err) {
                console.error(err);
                msg.innerText = "åŒ¯å‡ºå¤±æ•—: " + err.message;
                msg.classList.add('text-red-500');
            } finally {
                btn.disabled = false;
                btnText.innerText = "ğŸ“¥ åŒ¯å‡ºå®Œæ•´å¯¦é©—æ•¸æ“š (.csv)";
            }
        }
    </script>
</body>
</html>