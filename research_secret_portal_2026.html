<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶æ•¸æ“šç®¡ç†ä¸­å¿ƒ - SPSS å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 min-h-screen p-8">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-10">
        <h1 class="text-3xl font-extrabold text-slate-800 mb-2 flex items-center">
            ğŸ“Š å¯¦é©—æ•¸æ“šç®¡ç†å¾Œå°
        </h1>
        <p class="text-slate-500 mb-8 border-b pb-4">å°ˆç‚ºå­¸è¡“åˆ†æè¨­è¨ˆï¼Œæ”¯æ´è‡ªå‹•è³‡æ–™æ¸…æ´—èˆ‡ SPSS æ ¼å¼è½‰æ›</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="font-bold text-lg mb-2 text-gray-700">1. åŸå§‹æ•¸æ“šå‚™ä»½</h3>
                <p class="text-sm text-gray-500 mb-4">åŒ…å«æ‰€æœ‰åŸå§‹æ¬„ä½èˆ‡ JSON æ ¼å¼ï¼Œé©åˆé€²éšé–‹ç™¼æˆ–æ‰‹å‹•æª¢æŸ¥ã€‚</p>
                <button onclick="downloadRawData()" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-3 rounded-lg transition shadow-sm">
                    åŒ¯å‡ºåŸå§‹æ•¸æ“š (.csv)
                </button>
            </div>

            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                <h3 class="font-bold text-lg mb-2 text-blue-700">2. SPSS å°ˆç”¨æ¸…æ´—æª” (æ¨è–¦)</h3>
                <p class="text-sm text-blue-500 mb-4">è‡ªå‹•æå–é‡è¡¨åˆ†æ•¸ã€è½‰æ›ç§’æ•¸ã€ç·¨ç¢¼çµ„åˆ¥ï¼Œä¸‹è¼‰å¾Œå¯ç›´æ¥åŒ¯å…¥ SPSSã€‚</p>
                <button onclick="downloadSPSSData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-md">
                    ğŸ“¥ ä¸‹è¼‰ SPSS å°ˆç”¨æ¸…æ´—æª”
                </button>
            </div>
        </div>

        <div id="status-msg" class="mt-8 text-center text-sm font-medium py-3 rounded-lg hidden"></div>
    </div>

    <script>
        const supabaseUrl = 'https://gceaxslljccatxvvohtx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjZWF4c2xsamNjYXR4dnZvaHR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTI1ODAsImV4cCI6MjA4NjM2ODU4MH0.QJvdg8gYt_zX8HN7rfylt2UrgNhJ8HeldygRkaVhEX8';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // åŠŸèƒ½ A: åŸå§‹æ•¸æ“šä¸‹è¼‰ (åŸæœ¬çš„åŠŸèƒ½)
        async function downloadRawData() {
            updateStatus("æ­£åœ¨æº–å‚™åŸå§‹æ•¸æ“š...", "gray");
            const { data, error } = await _supabase.from('experiment_results').select('*').order('created_at');
            if (error) { updateStatus("å‡ºéŒ¯äº†: " + error.message, "red"); return; }
            triggerDownload(data, "raw_data_backup");
        }

        // åŠŸèƒ½ B: SPSS å°ˆç”¨æ¸…æ´—ä¸‹è¼‰ (æ–°åŠŸèƒ½)
        async function downloadSPSSData() {
            updateStatus("æ­£åœ¨é€²è¡Œæ•¸æ“šæ¸…æ´—èˆ‡è½‰æ›...", "blue");
            
            try {
                const { data, error } = await _supabase.from('experiment_results').select('*').order('created_at');
                if (error) throw error;
                if (!data || data.length === 0) { alert("ç›®å‰è³‡æ–™åº«æ²’æœ‰æ•¸æ“šï¼"); return; }

                // å®šç¾© SPSS å°ˆç”¨çš„æ¨™é¡Œ
                const headers = [
                    'user_id', 'group', 'group_code', 'stage', 'trial_number', 
                    'stimulus_id', 'is_ai_generated_num', 'ai_suggestion', 
                    'user_choice', 'is_correct_num', 'rt_seconds', 'click_count', 'trust_score'
                ];

                const cleanedRows = [headers.join(',')];

                data.forEach(row => {
                    // 1. æå–ä¿¡ä»»é‡è¡¨åˆ†æ•¸ (è™•ç† JSON)
                    let trustScore = "";
                    try {
                        const sd = typeof row.survey_data === 'string' ? JSON.parse(row.survey_data) : row.survey_data;
                        trustScore = sd.trust_score || "";
                    } catch(e) { trustScore = ""; }

                    // 2. å»ºç«‹æ¸…æ´—å¾Œçš„è³‡æ–™è¡Œ
                    const line = [
                        row.user_id,                                    // å—è©¦è€… ID
                        row.group,                                      // çµ„åˆ¥åç¨±
                        row.group === 'One-way' ? 1 : 2,                // çµ„åˆ¥ä»£ç¢¼ (SPSS åˆ†æç”¨)
                        row.stage,                                      // éšæ®µ (1,2,3)
                        row.trial_number,                               // é¡Œè™Ÿ
                        row.stimulus_id,                                // åˆºæ¿€ç‰©åŸå§‹ ID
                        row.is_ai_generated ? 1 : 0,                    // æ˜¯å¦ç‚º AI å¯«çš„ (1/0)
                        row.ai_suggestion,                              // AI çµ¦çš„æ¨™ç±¤
                        row.user_choice,                                // ä½¿ç”¨è€…æœ€å¾Œé¸æ“‡
                        row.is_correct ? 1 : 0,                         // ä½¿ç”¨è€…æ˜¯å¦ç­”å° (1/0)
                        (row.response_time / 1000).toFixed(3),          // åæ‡‰æ™‚é–“ (è½‰ç‚ºç§’ï¼Œä¿ç•™ä¸‰ä½)
                        row.click_count,                                // çŒ¶è±«é»æ“Šæ¬¡æ•¸
                        trustScore                                      // é‡è¡¨åˆ†æ•¸ (1-7)
                    ];
                    cleanedRows.push(line.join(','));
                });

                triggerDownload(cleanedRows.join('\n'), "spss_cleaned_data", true);
                updateStatus(`æ¸…æ´—æˆåŠŸï¼å·²åŒ¯å‡º ${data.length} ç­†è³‡æ–™ã€‚`, "green");
            } catch (err) {
                updateStatus("æ¸…æ´—å¤±æ•—: " + err.message, "red");
            }
        }

        // é€šç”¨ä¸‹è¼‰è§¸ç™¼å™¨
        function triggerDownload(content, fileNamePrefix, isString = false) {
            let finalContent = isString ? content : JSON.stringify(content);
            if (!isString) {
                // å¦‚æœæ˜¯å‚³å…¥ JSON ç‰©ä»¶ï¼Œè½‰æ›ç‚ºåŸºæœ¬ CSV
                const headers = Object.keys(content[0]);
                const rows = content.map(row => headers.map(h => `"${String(row[h]).replace(/"/g, '""')}"`).join(','));
                finalContent = [headers.join(','), ...rows].join('\n');
            }

            const blob = new Blob(["\uFEFF" + finalContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${fileNamePrefix}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function updateStatus(msg, color) {
            const status = document.getElementById('status-msg');
            status.innerText = msg;
            status.className = `mt-8 text-center text-sm font-medium py-3 rounded-lg block `;
            if (color === "red") status.classList.add("bg-red-50", "text-red-700");
            if (color === "blue") status.classList.add("bg-blue-50", "text-blue-700");
            if (color === "green") status.classList.add("bg-green-50", "text-green-700");
            if (color === "gray") status.classList.add("bg-gray-50", "text-gray-700");
            status.classList.remove('hidden');
        }
    </script>
</body>
</html>