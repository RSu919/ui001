<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¦é©—æ•¸æ“šç®¡ç†å¾Œå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 min-h-screen p-8">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-10">

    <h1 class="text-3xl font-extrabold text-slate-800 mb-1">ğŸ“Š å¯¦é©—æ•¸æ“šç®¡ç†å¾Œå°</h1>
    <p class="text-slate-500 mb-2 text-sm">2 Ã— 3 å¯¦é©—è¨­è¨ˆï¼ˆæ–¹å‘ Ã— éŒ¯èª¤ç‡ï¼‰ï½œ54 é¡Œ / å—è©¦è€…</p>
    <div class="border-b pb-4 mb-8 flex gap-3 text-xs text-slate-400">
      <span class="bg-slate-100 px-2 py-1 rounded">OW_05ï¼šå–®å‘ 5%</span>
      <span class="bg-slate-100 px-2 py-1 rounded">OW_10ï¼šå–®å‘ 10%</span>
      <span class="bg-slate-100 px-2 py-1 rounded">OW_20ï¼šå–®å‘ 20%</span>
      <span class="bg-slate-100 px-2 py-1 rounded">TW_05ï¼šé›™å‘ 5%</span>
      <span class="bg-slate-100 px-2 py-1 rounded">TW_10ï¼šé›™å‘ 10%</span>
      <span class="bg-slate-100 px-2 py-1 rounded">TW_20ï¼šé›™å‘ 20%</span>
    </div>

    <!-- æ•¸æ“šæ¦‚è¦½ -->
    <div id="summary-box" class="grid grid-cols-3 gap-4 mb-8 hidden">
      <div class="bg-blue-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-blue-700" id="count-total">-</p>
        <p class="text-sm text-blue-500">ç¸½ç­†æ•¸</p>
      </div>
      <div class="bg-green-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-green-700" id="count-participants">-</p>
        <p class="text-sm text-green-500">å—è©¦è€…äººæ•¸</p>
      </div>
      <div class="bg-purple-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-purple-700" id="count-complete">-</p>
        <p class="text-sm text-purple-500">å®Œæ•´å®Œæˆäººæ•¸ï¼ˆ54é¡Œï¼‰</p>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
        <h3 class="font-bold text-lg mb-2 text-gray-700">1. åŸå§‹æ•¸æ“šå‚™ä»½</h3>
        <p class="text-sm text-gray-500 mb-4">åŒ…å«æ‰€æœ‰åŸå§‹æ¬„ä½ï¼Œé©åˆé€²éšåˆ†ææˆ–æ‰‹å‹•æª¢æŸ¥ã€‚</p>
        <button onclick="loadAndShow()" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-semibold py-3 rounded-lg transition">
          ğŸ” è¼‰å…¥ä¸¦é è¦½æ•¸æ“š
        </button>
      </div>

      <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
        <h3 class="font-bold text-lg mb-2 text-blue-700">2. SPSS å°ˆç”¨æ¸…æ´—æª”ï¼ˆæ¨è–¦ï¼‰</h3>
        <p class="text-sm text-blue-500 mb-4">è‡ªå‹•æå–é‡è¡¨åˆ†æ•¸ã€è½‰æ›æ¬„ä½ã€ç·¨ç¢¼çµ„åˆ¥ï¼Œå¯ç›´æ¥åŒ¯å…¥ SPSSã€‚</p>
        <button onclick="downloadSPSSData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
          ğŸ“¥ ä¸‹è¼‰ SPSS æ¸…æ´—æª” (.csv)
        </button>
      </div>
    </div>

    <!-- ç‹€æ…‹è¨Šæ¯ -->
    <div id="status-msg" class="mt-6 text-center text-sm font-medium py-3 rounded-lg hidden"></div>

    <!-- æ•¸æ“šé è¦½è¡¨æ ¼ -->
    <div id="preview-box" class="mt-8 hidden">
      <h3 class="font-bold text-gray-700 mb-3">æ•¸æ“šé è¦½ï¼ˆå‰ 20 ç­†ï¼‰</h3>
      <div class="overflow-x-auto">
        <table id="preview-table" class="text-xs w-full border-collapse">
          <thead class="bg-slate-100 text-slate-600"></thead>
          <tbody class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const supabaseUrl = 'https://gceaxslljccatxvvohtx.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjZWF4c2xsamNjYXR4dnZvaHR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTI1ODAsImV4cCI6MjA4NjM2ODU4MH0.QJvdg8gYt_zX8HN7rfylt2UrgNhJ8HeldygRkaVhEX8';
    const _supabase   = supabase.createClient(supabaseUrl, supabaseKey);

    async function fetchAll() {
      const { data, error } = await _supabase
        .from('experiment_results_v2')
        .select('*')
        .order('created_at');
      if (error) throw error;
      return data || [];
    }

    async function loadAndShow() {
      updateStatus('è¼‰å…¥ä¸­...', 'blue');
      try {
        const data = await fetchAll();
        showSummary(data);
        showPreview(data);
        updateStatus(`å…± ${data.length} ç­†è³‡æ–™è¼‰å…¥å®Œæˆã€‚`, 'green');
      } catch (err) {
        updateStatus('è¼‰å…¥å¤±æ•—ï¼š' + err.message, 'red');
      }
    }

    function showSummary(data) {
      const uniqueUsers   = new Set(data.map(r => r.user_id)).size;
      const trialCounts   = {};
      data.forEach(r => { trialCounts[r.user_id] = (trialCounts[r.user_id] || 0) + 1; });
      const completeCount = Object.values(trialCounts).filter(c => c >= 54).length;

      document.getElementById('count-total').innerText        = data.length;
      document.getElementById('count-participants').innerText = uniqueUsers;
      document.getElementById('count-complete').innerText     = completeCount;
      document.getElementById('summary-box').classList.remove('hidden');
    }

    function showPreview(data) {
      const preview = data.slice(0, 20);
      if (!preview.length) return;

      const keys   = Object.keys(preview[0]);
      const thead  = document.querySelector('#preview-table thead');
      const tbody  = document.querySelector('#preview-table tbody');

      thead.innerHTML = '<tr>' + keys.map(k => `<th class="px-2 py-1 text-left whitespace-nowrap">${k}</th>`).join('') + '</tr>';
      tbody.innerHTML = preview.map(row =>
        '<tr>' + keys.map(k => `<td class="px-2 py-1 whitespace-nowrap">${row[k] ?? ''}</td>`).join('') + '</tr>'
      ).join('');

      document.getElementById('preview-box').classList.remove('hidden');
    }

    async function downloadSPSSData() {
      updateStatus('æ­£åœ¨é€²è¡Œæ•¸æ“šæ¸…æ´—èˆ‡è½‰æ›...', 'blue');
      try {
        const data = await fetchAll();
        if (!data.length) { alert('ç›®å‰è³‡æ–™åº«æ²’æœ‰æ•¸æ“šï¼'); return; }

        // SPSS æ¬„ä½å®šç¾©
        const headers = [
          'user_id',
          'group_id',         // OW_05 / OW_10 / OW_20 / TW_05 / TW_10 / TW_20
          'direction',        // One-way / Two-way
          'direction_code',   // 1=One-way, 2=Two-way
          'error_rate',       // 0.05 / 0.10 / 0.20
          'error_rate_code',  // 1=5%, 2=10%, 3=20%
          'stage',
          'trial_number',
          'stimulus_id',
          'is_ai_generated',  // 1/0
          'ai_label',         // AI / Human
          'is_error_trial',   // 1/0
          'error_type',       // false_negative / false_positive / (ç©º)
          'user_choice',      // AI / Human
          'agreed_with_ai',   // 1/0
          'is_correct',       // 1/0
          'rt_seconds',
          'trust_q1',
          'trust_q2',
          'trust_q3',
          'trust_q4',
          'trust_avg',
          'survey_phase',
        ];

        const directionCode  = { 'One-way': 1, 'Two-way': 2 };
        const errorRateCode  = { 0.05: 1, 0.10: 2, 0.20: 3 };

        const rows = [headers.join(',')];
        data.forEach(row => {
          let sd = {};
          try { sd = typeof row.survey_data === 'string' ? JSON.parse(row.survey_data) : (row.survey_data || {}); } catch(e) {}

          const line = [
            row.user_id,
            row.group_id        || '',
            row.direction       || '',
            directionCode[row.direction] ?? '',
            row.error_rate      ?? '',
            errorRateCode[row.error_rate] ?? '',
            row.stage,
            row.trial_number,
            row.stimulus_id,
            row.is_ai_generated ? 1 : 0,
            row.ai_label        || '',
            row.is_error_trial  ? 1 : 0,
            row.error_type      || '',
            row.user_choice     || '',
            row.agreed_with_ai  ? 1 : 0,
            row.is_correct      ? 1 : 0,
            ((row.response_time || 0) / 1000).toFixed(3),
            sd.trust_q1   ?? '',
            sd.trust_q2   ?? '',
            sd.trust_q3   ?? '',
            sd.trust_q4   ?? '',
            sd.trust_avg  ?? '',
            sd.phase      ?? '',
          ];
          rows.push(line.join(','));
        });

        triggerDownload(rows.join('\n'), 'spss_cleaned_data');
        updateStatus(`æ¸…æ´—æˆåŠŸï¼å·²åŒ¯å‡º ${data.length} ç­†è³‡æ–™ã€‚`, 'green');
      } catch (err) {
        updateStatus('æ¸…æ´—å¤±æ•—ï¼š' + err.message, 'red');
      }
    }

    function triggerDownload(content, prefix) {
      const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href     = url;
      link.download = `${prefix}_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function updateStatus(msg, color) {
      const el = document.getElementById('status-msg');
      el.innerText = msg;
      el.className = 'mt-6 text-center text-sm font-medium py-3 rounded-lg block ';
      if (color === 'red')   el.classList.add('bg-red-50',    'text-red-700');
      if (color === 'blue')  el.classList.add('bg-blue-50',   'text-blue-700');
      if (color === 'green') el.classList.add('bg-green-50',  'text-green-700');
      el.classList.remove('hidden');
    }
  </script>
</body>
</html>
