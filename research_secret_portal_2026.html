<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¯¦é©—æ•¸æ“šç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen p-10">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-slate-800 mb-6 flex items-center">
            ğŸ“Š å¯¦é©—æ•¸æ“šä¸‹è¼‰ä¸­å¿ƒ
        </h1>

        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8 text-blue-700">
            <p class="text-sm font-medium">èªªæ˜ï¼šæŒ‰ä¸‹æŒ‰éˆ•å¾Œï¼Œç³»çµ±æœƒå¾ Supabase æŠ“å–æ‰€æœ‰ `experiment_results` çš„è³‡æ–™ï¼Œä¸¦è‡ªå‹•è½‰æ›æˆ CSV æª”æ¡ˆä¸‹è¼‰ã€‚</p>
        </div>

        <div class="flex gap-4">
            <button id="download-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 flex justify-center items-center">
                <span id="btn-text">ä¸‹è¼‰å…¨é‡ CSV æ•¸æ“š</span>
                <svg id="loader" class="hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

        <div id="status-msg" class="mt-4 text-center text-sm text-gray-500"></div>
    </div>

    <script>
        // 1. è¨­å®šæ‚¨çš„ Supabase é‡‘é‘°
        const supabaseUrl = 'https://gceaxslljccatxvvohtx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjZWF4c2xsamNjYXR4dnZvaHR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTI1ODAsImV4cCI6MjA4NjM2ODU4MH0.QJvdg8gYt_zX8HN7rfylt2UrgNhJ8HeldygRkaVhEX8';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const btn = document.getElementById('download-btn');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader');
        const statusMsg = document.getElementById('status-msg');

        btn.addEventListener('click', async () => {
            // UI ç‹€æ…‹åˆ‡æ› 
            btn.disabled = true;
            loader.classList.remove('hidden');
            btnText.innerText = 'æ­£åœ¨æ“·å–æ•¸æ“š...';

            try {
                // 2. å¾ Supabase æŠ“å–è³‡æ–™
                const { data, error } = await _supabase
                    .from('experiment_results')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) throw error;
                if (data.length === 0) {
                    alert('ç›®å‰è³‡æ–™åº«ä¸­å°šç„¡æ•¸æ“šï¼');
                    return;
                }

                // 3. è½‰æ›ç‚º CSV æ ¼å¼
                const csvContent = convertToCSV(data);
                
                // 4. è§¸ç™¼ç€è¦½å™¨ä¸‹è¼‰
                downloadCSV(csvContent, `experiment_data_${new Date().toISOString().split('T')[0]}.csv`);

                statusMsg.innerText = `æˆåŠŸåŒ¯å‡º ${data.length} ç­†è³‡æ–™`;
            } catch (err) {
                console.error(err);
                alert('æŠ“å–è³‡æ–™å¤±æ•—ï¼š' + err.message);
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
                btnText.innerText = 'ä¸‹è¼‰å…¨é‡ CSV æ•¸æ“š';
            }
        });

        // JSON è½‰ CSV å‡½å¼
        function convertToCSV(objArray) {
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            const headers = Object.keys(array[0]).join(',');
            const rows = array.map(row => {
                return Object.values(row).map(value => {
                    // è™•ç† JSONB æ ¼å¼çš„å•å·è³‡æ–™ï¼Œå°‡å…¶è½‰ç‚ºå­—ä¸²ä¸¦è·³è„«å¼•è™Ÿ
                    if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                    return `"${value}"`;
                }).join(',');
            });
            return [headers, ...rows].join('\r\n');
        }

        // ä¸‹è¼‰æª”æ¡ˆå‡½å¼
        function downloadCSV(content, fileName) {
            const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' }); // åŠ å…¥ BOM é˜²æ­¢ä¸­æ–‡äº‚ç¢¼
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>